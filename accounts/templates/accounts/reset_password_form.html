<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova senha</title>
<style>
:root {
  --primary: #4f46e5;
  --primary-hover: #4338ca;
  --success: #16a34a;
  --error: #dc2626;
  --bg: #f9fafb;
  --text: #374151;
  --muted: #6b7280;
}

body { 
  font-family: 'Segoe UI', Roboto, sans-serif; 
  background: var(--bg); 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  height: 100vh; 
  margin: 0;
}

.container { 
  background: #fff; 
  padding: 40px; 
  border-radius: 16px; 
  box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
  max-width: 420px; 
  width: 100%; 
  animation: fadeIn 0.5s ease-in-out;
}

h2 { 
  margin-bottom: 20px; 
  color: var(--text); 
  font-size: 22px; 
  font-weight: 600; 
  text-align: center; 
}

input { 
  width: 100%; 
  padding: 14px; 
  margin: 12px 0; 
  border-radius: 10px; 
  border: 1px solid #d1d5db; 
  font-size: 15px; 
  transition: all 0.3s; 
  outline: none;
}

input:focus { 
  border-color: var(--primary); 
  box-shadow: 0 0 0 3px rgba(79,70,229,0.2); 
}

input.valid { border-color: var(--success); }
input.invalid { border-color: var(--error); }

button { 
  width: 100%; 
  padding: 14px; 
  font-size: 16px; 
  background: var(--primary); 
  color: #fff; 
  border: none; 
  border-radius: 10px; 
  cursor: pointer; 
  transition: background 0.3s, transform 0.2s;
  margin-top: 10px;
}

button:hover:not(:disabled) { 
  background: var(--primary-hover); 
  transform: translateY(-2px);
}

button:disabled { 
  background: #d1d5db; 
  cursor: not-allowed; 
}

.message { 
  margin-top: 20px; 
  font-size: 14px; 
  text-align: center; 
}

.error { color: var(--error); }
.success { color: var(--success); }

.rules { 
  text-align: left; 
  font-size: 13px; 
  margin-top: 15px; 
  list-style: none; 
  padding: 0;
}

.rules li { 
  margin: 6px 0; 
  color: var(--muted); 
  display: flex; 
  align-items: center;
}

.rules li::before { 
  content: "‚Ä¢"; 
  margin-right: 8px; 
  color: var(--error); 
  font-weight: bold;
}

.rules li.valid { color: var(--success); }
.rules li.valid::before { color: var(--success); }

.toggle-btn { 
  cursor: pointer; 
  font-size: 12px; 
  margin-left: 5px; 
  color: var(--primary); 
  position: absolute; 
  right: 12px; 
  top: 50%; 
  transform: translateY(-50%); 
}

.strength-container { 
  width: 100%; 
  background: #e5e7eb; 
  height: 8px; 
  border-radius: 5px; 
  margin-top: 6px; 
}

.strength-bar { 
  height: 8px; 
  border-radius: 5px; 
  width: 0%; 
  transition: width 0.3s, background 0.3s; 
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>
<div class="container">
    <h2>Defina sua nova senha</h2>
    <div style="position:relative;">
        <input type="password" id="password" placeholder="Nova senha">
        <span class="toggle-btn" onclick="togglePassword('password')">üëÅ</span>
        <div class="strength-container"><div id="strengthBar" class="strength-bar"></div></div>
    </div>
    <div style="position:relative;">
        <input type="password" id="confirm_password" placeholder="Confirme a senha">
        <span class="toggle-btn" onclick="togglePassword('confirm_password')">üëÅ</span>
    </div>

    <ul class="rules" id="rules">
        <li id="rule-length">M√≠nimo de 8 caracteres</li>
        <li id="rule-upper">Pelo menos 1 letra mai√∫scula</li>
        <li id="rule-lower">Pelo menos 1 letra min√∫scula</li>
        <li id="rule-number">Pelo menos 1 n√∫mero</li>
        <li id="rule-special">Pelo menos 1 caractere especial (!@#$...)</li>
        <li id="rule-match">As senhas devem coincidir</li>
    </ul>

    <button id="submitBtn" disabled>Redefinir senha</button>
    <div class="message" id="message"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const uid = urlParams.get('uid');
const token = urlParams.get('token');

const passwordInput = document.getElementById('password');
const confirmInput = document.getElementById('confirm_password');
const submitBtn = document.getElementById('submitBtn');
const strengthBar = document.getElementById('strengthBar');

const rules = {
    length: document.getElementById('rule-length'),
    upper: document.getElementById('rule-upper'),
    lower: document.getElementById('rule-lower'),
    number: document.getElementById('rule-number'),
    special: document.getElementById('rule-special'),
    match: document.getElementById('rule-match'),
};

function validatePassword(){
    const password = passwordInput.value;
    const confirm = confirmInput.value;

    const validations = {
        length: password.length >= 8,
        upper: /[A-Z]/.test(password),
        lower: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
        match: password && confirm && password === confirm
    };

    for (let rule in validations){
        if(validations[rule]){
            rules[rule].classList.add('valid');
        } else {
            rules[rule].classList.remove('valid');
        }
    }

    if(password){
        passwordInput.classList.toggle('valid', validations.length && validations.upper && validations.lower && validations.number && validations.special);
        passwordInput.classList.toggle('invalid', !(validations.length && validations.upper && validations.lower && validations.number && validations.special));
    } else {
        passwordInput.classList.remove('valid','invalid');
    }

    if(confirm){
        confirmInput.classList.toggle('valid', validations.match);
        confirmInput.classList.toggle('invalid', !validations.match);
    } else {
        confirmInput.classList.remove('valid','invalid');
    }

    let score = 0;
    if(validations.length) score++;
    if(validations.upper) score++;
    if(validations.lower) score++;
    if(validations.number) score++;
    if(validations.special) score++;

    let strength = (score / 5) * 100;
    strengthBar.style.width = strength + "%";

    if(score <= 2){
        strengthBar.style.background = "#dc2626"; // vermelho
    } else if(score === 3){
        strengthBar.style.background = "#f59e0b"; // laranja
    } else if(score === 4){
        strengthBar.style.background = "#facc15"; // amarelo
    } else if(score === 5){
        strengthBar.style.background = "#16a34a"; // verde
    }

    const allValid = Object.values(validations).every(Boolean);
    submitBtn.disabled = !allValid;
}

passwordInput.addEventListener('input', validatePassword);
confirmInput.addEventListener('input', validatePassword);

function togglePassword(fieldId){
    const input = document.getElementById(fieldId);
    input.type = input.type === "password" ? "text" : "password";
}

document.getElementById('submitBtn').addEventListener('click', async () => {
    const password = passwordInput.value;
    const confirm_password = confirmInput.value;
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = '';

    try {
        const res = await fetch(`/auth/reset-password/?uid=${uid}&token=${token}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password, confirm_password })
        });
        const data = await res.json();
        if(res.ok){
            messageDiv.textContent = "Senha redefinida com sucesso!";
            messageDiv.className = "message success";
        } else {
            messageDiv.textContent = data.detail || "Erro ao redefinir senha.";
            messageDiv.className = "message error";
        }
    } catch(err){
        messageDiv.textContent = "Erro de rede, tente novamente.";
        messageDiv.className = "message error";
    }
});
</script>
</body>
</html>
